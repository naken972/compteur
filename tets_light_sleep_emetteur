#include <esp_now.h>
#include <WiFi.h>
#include <esp_sleep.h>

// ------------------- CONFIGURATION -------------------
uint8_t receiverMacAddress[] = {0xEC, 0xE3, 0x34, 0x67, 0x56, 0xBC}; 

const int BTN_TEAM1_PIN = 2;
const int BTN_TEAM2_PIN = 3;
const int BTN_UNDO_PIN  = 4;

// ------------------- STRUCTURE -------------------
typedef struct struct_message {
    int action;
} struct_message;

struct_message myData;

// ------------------- DEBOUNCE / APPUI LONG -------------------
unsigned long debounceDelay = 50;
unsigned long lastDebounceTimeBtn1 = 0;
unsigned long lastDebounceTimeBtn2 = 0;
unsigned long lastDebounceTimeBtn3 = 0;

int lastBtn1State = HIGH;
int lastBtn2State = HIGH;
int lastBtn3State = HIGH;

int lastBtn1Reading = HIGH;
int lastBtn2Reading = HIGH;
int lastBtn3Reading = HIGH;

const unsigned long REQUIRED_LONG_PRESS_DURATION = 3000;
unsigned long undoButtonPressTime = 0;
bool undoButtonSentLongPress = false;

// ------------------- ESP-NOW CALLBACK -------------------
void OnDataSent(const wifi_tx_info_t *, esp_now_send_status_t status) {
    Serial.println(status == ESP_NOW_SEND_SUCCESS ? "EnvoyÃ© âœ…" : "Ã‰chec âŒ");
}

void sendAction(int action) {
    myData.action = action;
    esp_now_send(receiverMacAddress, (uint8_t*)&myData, sizeof(myData));
}

// ------------------- SETUP -------------------
void setup() {
    Serial.begin(115200);

    pinMode(BTN_TEAM1_PIN, INPUT_PULLUP);
    pinMode(BTN_TEAM2_PIN, INPUT_PULLUP);
    pinMode(BTN_UNDO_PIN, INPUT_PULLUP);

    WiFi.mode(WIFI_STA);
    WiFi.setSleep(false); // important : on gÃ¨re le sleep nous-mÃªmes

    esp_now_init();
    esp_now_register_send_cb(OnDataSent);

    esp_now_peer_info_t peerInfo = {};
    memcpy(peerInfo.peer_addr, receiverMacAddress, 6);
    esp_now_add_peer(&peerInfo);

    // GPIO wake-up (n'importe quel bouton)
    esp_sleep_enable_gpio_wakeup();
    gpio_wakeup_enable((gpio_num_t)BTN_TEAM1_PIN, GPIO_INTR_LOW_LEVEL);
    gpio_wakeup_enable((gpio_num_t)BTN_TEAM2_PIN, GPIO_INTR_LOW_LEVEL);
    gpio_wakeup_enable((gpio_num_t)BTN_UNDO_PIN,  GPIO_INTR_LOW_LEVEL);
}

// ------------------- LOOP -------------------
void loop() {
    unsigned long currentTime = millis();
    bool activity = false;

    // --- Bouton 1 ---
    int r1 = digitalRead(BTN_TEAM1_PIN);
    if (r1 != lastBtn1Reading) lastDebounceTimeBtn1 = currentTime;
    if ((currentTime - lastDebounceTimeBtn1) > debounceDelay && r1 != lastBtn1State) {
        lastBtn1State = r1;
        if (r1 == LOW) sendAction(1);
        activity = true;
    }
    lastBtn1Reading = r1;

    // --- Bouton 2 ---
    int r2 = digitalRead(BTN_TEAM2_PIN);
    if (r2 != lastBtn2Reading) lastDebounceTimeBtn2 = currentTime;
    if ((currentTime - lastDebounceTimeBtn2) > debounceDelay && r2 != lastBtn2State) {
        lastBtn2State = r2;
        if (r2 == LOW) sendAction(2);
        activity = true;
    }
    lastBtn2Reading = r2;

    // --- Bouton 3 ---
    int r3 = digitalRead(BTN_UNDO_PIN);
    if (r3 != lastBtn3Reading) lastDebounceTimeBtn3 = currentTime;

    if ((currentTime - lastDebounceTimeBtn3) > debounceDelay) {
        if (r3 == LOW && lastBtn3State == HIGH) {
            undoButtonPressTime = currentTime;
            undoButtonSentLongPress = false;
        }

        if (r3 == LOW && !undoButtonSentLongPress &&
            (currentTime - undoButtonPressTime >= REQUIRED_LONG_PRESS_DURATION)) {
            sendAction(4);
            undoButtonSentLongPress = true;
            activity = true;
        }

        if (r3 == HIGH && lastBtn3State == LOW && !undoButtonSentLongPress) {
            sendAction(3);
            activity = true;
        }

        lastBtn3State = r3;
    }
    lastBtn3Reading = r3;

    // ðŸŒ™ Light sleep si aucune activitÃ©
    if (!activity) {
        esp_light_sleep_start();
    }
}
