#include <esp_now.h>
#include <WiFi.h>
#include <esp_wifi.h>

// -------- CONFIG --------
uint8_t receiverMacAddress[] = {0xD4, 0xE9, 0xF4, 0xA5, 0x0B, 0x50};

#define BTN_TEAM1_PIN 2
#define BTN_TEAM2_PIN 3
#define BTN_UNDO_PIN  4

#define DEBOUNCE_MS 200     // simple et efficace
#define LONG_PRESS_MS 3000  // appui long = 3 secondes

typedef struct {
  int action;
} struct_message;

struct_message myData;

// -------- STATES --------
int lastBtn1 = HIGH;
int lastBtn2 = HIGH;
int lastBtn3 = HIGH;

unsigned long lastActionTime1 = 0;
unsigned long lastActionTime2 = 0;
unsigned long lastActionTime3 = 0;

unsigned long btn1PressStart = 0;
unsigned long btn3PressStart = 0;
bool longPressSentBtn1 = false;
bool longPressSentBtn3 = false;

// -------- CALLBACK --------
void OnDataSent(const wifi_tx_info_t *info, esp_now_send_status_t status) {
  Serial.println(status == ESP_NOW_SEND_SUCCESS ? "EnvoyÃ© âœ…" : "Ã‰chec âŒ");
  esp_wifi_set_ps(WIFI_PS_MAX_MODEM); // radio dort
}

// -------- SEND --------
void sendAction(int action) {
  Serial.print("Action ");
  Serial.print(action);
  Serial.println(" envoyÃ©e");

  esp_wifi_set_ps(WIFI_PS_MIN_MODEM); // radio ON
  myData.action = action;
  esp_now_send(receiverMacAddress, (uint8_t*)&myData, sizeof(myData));
}

// -------- SETUP --------
void setup() {
  Serial.begin(115200);
  delay(200);

  setCpuFrequencyMhz(80);   // ðŸ”‹ gros gain
  Serial.println("CPU 80 MHz");

  pinMode(BTN_TEAM1_PIN, INPUT_PULLUP);
  pinMode(BTN_TEAM2_PIN, INPUT_PULLUP);
  pinMode(BTN_UNDO_PIN,  INPUT_PULLUP);

  WiFi.mode(WIFI_STA);
  btStop();

  esp_wifi_set_ps(WIFI_PS_MAX_MODEM);

  esp_now_init();
  esp_now_register_send_cb(OnDataSent);

  esp_now_peer_info_t peerInfo = {};
  memcpy(peerInfo.peer_addr, receiverMacAddress, 6);
  peerInfo.channel = 0;
  peerInfo.encrypt = false;
  esp_now_add_peer(&peerInfo);

  Serial.println("PrÃªt (version fiable)");
}

// -------- LOOP --------
void loop() {
  unsigned long now = millis();

  int r1 = digitalRead(BTN_TEAM1_PIN);
  int r2 = digitalRead(BTN_TEAM2_PIN);
  int r3 = digitalRead(BTN_UNDO_PIN);

  // --- TEAM 1 ---
  if (r1 == LOW) {
    if (lastBtn1 == HIGH) {
      // premier appui dÃ©tectÃ©
      btn1PressStart = now;
      longPressSentBtn1 = false;
    } else if (!longPressSentBtn1 && (now - btn1PressStart) >= LONG_PRESS_MS) {
      // appui long dÃ©tectÃ©
      sendAction(5);
      longPressSentBtn1 = true;
      lastActionTime1 = now; // Ã©viter appui court aprÃ¨s
    }
  } else {
    // bouton relÃ¢chÃ©
    if (lastBtn1 == LOW && !longPressSentBtn1 && (now - lastActionTime1) > DEBOUNCE_MS) {
      // appui court
      lastActionTime1 = now;
      sendAction(1);
    }
  }
  lastBtn1 = r1;

  // --- TEAM 2 ---
  if (lastBtn2 == HIGH && r2 == LOW && (now - lastActionTime2) > DEBOUNCE_MS) {
    lastActionTime2 = now;
    sendAction(2);
  }
  lastBtn2 = r2;

  // --- UNDO (Bouton 3) ---
  if (r3 == LOW) {
    if (lastBtn3 == HIGH) {
      // premier appui dÃ©tectÃ©
      btn3PressStart = now;
      longPressSentBtn3 = false;
    } else if (!longPressSentBtn3 && (now - btn3PressStart) >= LONG_PRESS_MS) {
      // appui long dÃ©tectÃ©
      sendAction(4);
      longPressSentBtn3 = true;
      lastActionTime3 = now; // Ã©viter appui court aprÃ¨s
    }
  } else {
    // bouton relÃ¢chÃ©
    if (lastBtn3 == LOW && !longPressSentBtn3 && (now - lastActionTime3) > DEBOUNCE_MS) {
      // appui court
      lastActionTime3 = now;
      sendAction(3);
    }
  }
  lastBtn3 = r3;

  delay(10); // CPU idle
}
